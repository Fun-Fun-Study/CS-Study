## 🗒️ 프로세스 주소 공간

프로세스는 **운영체제가 자원을 할당하는 단위**

프로세스가 메모리를 할당 받으면, 자신만의 방법으로 메모리를 관리하기 위해 이 공간들을 어떤 구조로 관리하는데, 우리는 이를 **프로세스 주소 공간**이라고 부른다.

메모리는 한정되어 있기 때문에, 데이터를 최대한 공유하여 메모리 중복 사용을 피하고 Memory 사용량을 최소화하기 위해 관리.

## 🗒️ 프로세스 주소 공간

<img src="https://github.com/Fun-Fun-Study/CS-Study/assets/18045556/aad4e075-4dfa-4e7d-b7b3-2dcec958b8cc">

- **Code (Text) 영역**:
  - 프로그램을 실행시키는 실행 파일 내의 명령어들이 위치하는 공간
  - 프로그램의 코드는 수정되면 안되므로, Read-Only 상태로 지정
  - 같은 프로그램으로 실행된 여러 프로세스는 동일한 코드를 가진다.
    - 동일한 내용을 중복 할당하지 않고 특정 공간에 할당하여 메모리 사용량을 절약
- **Data 영역**:
  - 전역 변수나 Static 변수 등 프로그램이 사용할 수 있는 데이터를 저장하는 영역
  - 어떤 프로그램에 전역/static 변수를 참조하는 코드가 존재한다면, 이 프로그램은 컴파일 된 후에 data 영역을 참조
  - 프로그램의 시작과 함께 할당되며, 프로그램이 종료되면 소멸
  - 초기화 된 데이터는 Data 영역에 저장되고,초기화 되지 않은 데이터는 BSS(Block Stated Symbol)영역에 저장
- **Stack 영역**:
  - 함수의 호출과 관계되는 *지역 변수와 매개변수*가 저장되는 영역
  - Stack 영역의 값은 함수의 호출과 함께 할당되며, 함수의 호출이 완료되면 소멸
  - 메모리의 높은 주소에서 낮은 주소의 방향으로 할당
  - 재귀 함수가 너무 깊게 호출되거나 함수가 지역변수를 너무 많이 가지고 있어 stack 영역을 초과하면 stack overflow 에러 발생
- **Heap 영역**:
  - **런타임에 크기가 결정되는** 영역
  - 사용자에 의해 공간이 동적으로 할당 및 해제
  - 주로 참조형 데이터 (ex. 클래스) 등의 데이터가 할당
  - 메모리의 낮은 주소에서 높은 주소의 방향으로 할당

## 🗒️ 프로세스 주소 공간의 최적화

### Data 영역과 Stack 영역

Code 영역은 기계어 코드가 들어있으니 다른 구역과 너무 다르고, Heap 영역은 런타임에 크기가 결정되는 영역이다.

그렇다면 Stack 영역과 Data 영역을 구분한 이유는 무엇일까? 가장 큰 이유는 **역할의 분배**이다. 우리는 Stack 영역을 통해 함수의 흐름을 관리하고, Data 영역 (+BSS 영역)을 통해 전역 변수, static 변수를 관리한다.

조금 뒤에서 자세히 설명하겠지만, 만약 한 프로세스가 여러개의 스레드를 갖는다면, 각각의 스레드는 자신만의 Stack 영역을 갖는다. 이는 스레드 내에서 수행되는 함수의 흐름을 각각 관리하기 위함이다.

여기에서 영역을 구분한 또 다른 중요한 이유가 나오는데, 바로 **Data 영역의 공유**이다. 각각의 스레드는 Stack 영역을 갖긴 하지만 Data 영역은 공유한다. 즉, 각각의 스레드가 사용하기 위해 Data 영역의 동일한 내용을 공유함으로써, 똑같은 공간을 여러개 만들지 않고 메모리를 절약할 수 있다. (이는 Code 영역에서도 마찬가지다!)

### Stack 영역 과 Heap 영역

```
java -Xmx4096m test
```

이 명령어는 *test* 라는 이름을 갖는 프로그램을 JVM 상에서 실행하되, 최대 힙 크기를 4096M (= 4G) 할당하라는 의미이다.

추가로, UNIX 계열 운영체제의 경우 다음과 같은 명령어를 통해 Stack 영역의 최대 크기를 확인할 수 있다.

```
ulimit -s
```

이 명령어를 이용하면 Stack 영역의 최대 크기를 수정할 수도 있지만, 현재 최대 크기도 확인할 수 있는데, 딱 8MB라고 나올 것이다.

어? Stack 영역과 Heap 영역은 같은 공간을 공유하는게 아니었나? 왜 필요한 크기가 다를까?

<img src="https://github.com/Fun-Fun-Study/CS-Study/assets/101235186/6087b876-4e85-485c-867d-10a2c3dfb9c2">

위 그림은 Java에서의 Stack 영역과 Heap 영역을 나타낸다. 잘 살펴보면, Stack 영역에 등장하는 각각의 변수들은 Heap 영역에 위치한 실제 Object의 참조를 갖고 있는 것을 볼 수 있다. 즉, 실제 객체는 Heap 영역에서 관리되기 때문에 Stack 영역의 크기는 생각보다 클 필요가 없다는 것을 알 수 있다.

클 필요가 없다는 것은 알았는데, 그렇다면 정말 두 영역은 서로 같은 공간을 공유하는게 아닌건가?

사실, Stack 영역은 생성과 동시에 크기가 정해진다. 즉, 크기가 한 번 정해지면 바뀌지 않기 때문에, Heap 영역과 상관 없이 크기의 제한을 갖는다. 즉, 우리가 자주 볼 수 있는 Stack Overflow 같은 문제는, 힙 영역을 침범해서가 아니라 정해진 Stack 영역의 크기를 초과해서 발생한 문제라고 볼 수 있다.

<img src="https://github.com/Fun-Fun-Study/CS-Study/assets/18045556/54a8e224-f754-420b-9f26-4dddcfb835c8">

stack의 지역변수는 사용되고 소멸하기 때문에 데이터 용량의 불확실성을 가진다.따라서 stack 영역에서의 주소값은 밑에서부터 채워지며, 주소는 선언된 순서대로 정해진다.
반면 힙 영역에서의 주소값은 위에서부터 채워 내려가기 때문에, 두 메모리 영역의 주소가 겹치게 되는 오버플로우가 발생할 수 있다.</br>
힙이 스택을 침범하는 경우를 **힙 오버 플로우**라 하고, 스택이 힙을 침범하는 경우를 **스택 오버 플로우**라고 한다.

### 스레드가 여러 개 있다면?

프로세스가 자원을 할당 받지만, 스레드도 자신만의 자원을 갖고 있어야 한다. 따라서, 스레드도 자신만의 주소 공간을 갖고 있다.

하지만, 약간의 차이가 있다.

<img src="https://github.com/Fun-Fun-Study/CS-Study/assets/101235186/6e467b80-111c-4431-9607-ec255eacce58">

실제로 각 스레드가 갖고 있는 것은 Stack 영역으로 나머지 공간은 프로세스의 값을 함께 쓰고 있고, 즉 다른 스레드와 공유한다고 볼 수 있다.

이 때문에, Data 영역에 있는 자원은 동시에 여러 스레드가 접근할 수 있다.
